<!DOCTYPE html>

<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" type="text/css" />
    <title>Landmarkanator</title>
    <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script>
        function map_init() {
            var lat;
            var lng;
            navigator.geolocation.getCurrentPosition(function(pos) {
                coords = pos.coords;
                lat = coords.latitude;
                lng = coords.longitude;
                data_init(lat, lng);
            });     
        }
        function data_init(lat, lng) {
            var request = new XMLHttpRequest();
            var url = "https://defense-in-derpth.herokuapp.com/sendLocation";
            var params = "login=GABRIEL_BECKER&lat=" + lat + "&lng=" + lng;
            console.log(params);
            request.open("POST", url, true);
            request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            request.onreadystatechange = function() {
                if (request.readyState == 4) {
                    rawinfo = request.responseText;
                    mapinfo = JSON.parse(rawinfo);
                    console.log(mapinfo);
                    google_map_init(lat, lng, mapinfo)
                }
            };
            request.send(params);
        }
        function google_map_init(lat, lng, mapdata) {            
            latlng = new google.maps.LatLng(lat, lng);
            myOptions = { center: latlng , zoom: 14};
            map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            ppl_init(mapdata, map);
            landmark_init(mapdata, map);
            var mylocmark = new google.maps.Marker( {
                position: latlng,
                map: map,
                title: "You",
                animation: google.maps.Animation.DROP,
                icon: "you.png"
            });
            var mylocString = "<p>GABRIEL_BECKER</p>";
            var mylocWindow = new google.maps.InfoWindow({
                content: mylocString
            });
            mylocmark.addListener('click', function() {
                mylocWindow.open(map, mylocmark);
            });

        }
        function ppl_init(mapdata, map) {
            var curr_person = mapdata.people;
            var infowindow = new google.map.InfoWindow();
            for (i = 0 ; i < mapdata.people.length ; i++) {
                var latlng = new google.maps.LatLng(curr_person[i].lat, curr_person[i].lng )
                var pplmark = new google.maps.Marker( {
                    position: latlng,
                    map: map,
                    title: curr_person[i].login,
                    icon: "personicon.png"
                });
            }
        }
        function landmark_init(mapdata, map) {
            var curr_landmark = mapdata.landmarks;
            for (i = 0 ; i < mapdata.landmarks.length ; i++) {
                var lng = curr_landmark[i].geometry.coordinates[0];
                var lat = curr_landmark[i].geometry.coordinates[1];
                var latlng = new google.maps.LatLng(lat, lng)
                var landmark = new google.maps.Marker( {
                    position: latlng,
                    map: map,
                    title: curr_landmark[i].properties.Location_Name,
                    icon: "poi.png"
                });
            }
        }
    </script>
    
</head>

<body onload="map_init()">
    <div id="map_canvas">
</body>

</html>